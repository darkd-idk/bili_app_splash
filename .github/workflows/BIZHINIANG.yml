name: Wallpaper Girl Sync

on:
  workflow_dispatch:
  schedule:
    - cron: '10 1 * * *'  # UTC 01:10 (åŒ—äº¬ 09:10)
  
  push:
    paths-ignore:
      - 'bizhiniang/**'
      - 'urls.txt'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync-wallpapers:
    name: Synchronize Wallpaper Images
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      OUTPUT_DIR: bizhiniang
      REPORT_FILE: wallpapers_report.md
      URL_LIST_FILE: urls.txt
      SCRIPT_FILE: getwallpaper.py

    steps:
      # æ­¥éª¤1: å‡†å¤‡çŽ¯å¢ƒ
      - name: Configure Environment
        run: echo "WORKFLOW STARTED AT: $(date)"
        shell: bash

      # æ­¥éª¤2: æ£€å‡ºä»“åº“ï¼ˆåŒ…å« urls.txtï¼‰
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            getwallpaper.py
            requirements.txt
            ${{ env.OUTPUT_DIR }}/
            ${{ env.URL_LIST_FILE }}   # æ˜Žç¡®åŒ…å« urls.txt
            .github/
          sparse-checkout-cone-mode: false
          persist-credentials: true

      # æ­¥éª¤3: è®¾ç½®PythonçŽ¯å¢ƒ
      - name: Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # æ­¥éª¤4: å®‰è£…ä¾èµ–
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip cache purge
          pip install -r requirements.txt

      # æ­¥éª¤5: æ‰§è¡Œä¸‹è½½ (ä¿®å¤ --log-file å‚æ•°é—®é¢˜)
      - name: Download Wallpapers
        env:
          SESSDATA: ${{ secrets.SESSDATA }}
        run: |
          set -euo pipefail
          
          # éªŒè¯çŽ¯å¢ƒå˜é‡
          if [ -z "${SESSDATA}" ]; then
            echo "::error::Missing SESSDATA environment variable"
            exit 1
          fi
          
          echo "Starting wallpaper download with SESSDATA=${SESSDATA:0:4}..."
          
          # æ‰§è¡Œä¸‹è½½è„šæœ¬ - å·²ä¿®å¤ --log-file å‚æ•°æ”¯æŒ
          python ${{ env.SCRIPT_FILE }} \
            --sessdata "${SESSDATA}" \
            --output "${{ env.OUTPUT_DIR }}" \
            --log-file wallpapers.log \
            || echo "::warning::Download completed with warnings"
          
          echo "Completed download process"
        
      # æ­¥éª¤6: å‡†å¤‡æäº¤
      - name: Configure Git Settings
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions@users.noreply.github.com"
          git config --global pull.rebase false
          git config --global http.postBuffer 157286400

      # æ­¥éª¤7: æäº¤å˜æ›´ (ä¿®å¤ç¨€ç–æ£€å‡ºé—®é¢˜)
      - name: Commit Changes
        run: |
          set -euo pipefail
          
          # æ£€æŸ¥å˜æ›´
          git status --short
          
          # æ·»åŠ ä¸‹è½½ç›®å½•å’ŒURLåˆ—è¡¨
          git add "${{ env.OUTPUT_DIR }}"
          git add "${{ env.URL_LIST_FILE }}"
          
          if ! git diff-index --quiet HEAD --; then
            echo "Changes detected, committing..."
            git commit -m "ðŸ–¼ï¸ Automated wallpaper sync [skip ci]"
            echo "Changes committed"
          else
            echo "No changes to commit"
          fi

      # æ­¥éª¤8: æŽ¨é€å˜æ›´
      - name: Push Changes
        run: |
          set -euo pipefail
          
          # é…ç½®è¿œç¨‹URL
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/$GITHUB_REPOSITORY"
          
          # é‡è¯•é€»è¾‘
          for i in {1..3}; do
            if git push origin "HEAD:$GITHUB_REF_NAME"; then
              echo "Push successful"
              exit 0
            else
              echo "Push failed, retry $i/3 in 10 seconds"
              sleep 10
            fi
          done
          
          echo "::error::Push failed after 3 attempts"
          exit 1
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}

      # æ­¥éª¤9: ç”ŸæˆæŠ¥å‘Š
      - name: Generate Wallpaper Report
        run: |
          set -euo pipefail
          
          # å¦‚æžœæ—¥å¿—æ–‡ä»¶å­˜åœ¨åˆ™è®°å½•æœ€åŽ10è¡Œ
          if [ -f wallpapers.log ]; then
            log_tail="\n### Log Summary\n\`\`\`\n$(tail -n 10 wallpapers.log)\n\`\`\`"
          else
            log_tail="\n### Log Summary\nNo log file found"
          fi
          
          # è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
          album_count=0
          file_count=0
          
          if [ -d "${{ env.OUTPUT_DIR }}" ]; then
            album_count=$(find "${{ env.OUTPUT_DIR }}" -mindepth 1 -maxdepth 1 -type d | wc -l)
            file_count=$(find "${{ env.OUTPUT_DIR }}" -type f | wc -l)
          fi
          
          # ç”ŸæˆMarkdownæŠ¥å‘Š
          cat > "${{ env.REPORT_FILE }}" << EOF
# Wallpaper Sync Report
          
## Summary
| Metric | Value |
|---|---|
| **Sync Time** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |
| **Workflow Run** | [Link](https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID) |
| **Output Directory** | ${{ env.OUTPUT_DIR }} |
| **Album Count** | $album_count |
| **Image Count** | $file_count |
| **Git Reference** | ${{ github.ref_name }} |
          
## Latest Albums
\`\`\`
$(ls -lt "${{ env.OUTPUT_DIR }}" | head -n 6)
\`\`\`
          
## URL Statistics
\`\`\`
$(wc -l < "${{ env.URL_LIST_FILE }}" | xargs) URLs recorded
\`\`\`
$log_tail
EOF
          
          echo "Generated report at ${{ env.REPORT_FILE }}"
          
      # æ­¥éª¤10: ä¸Šä¼ åˆ¶å“
      - name: Upload Sync Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wallpaper-sync-artifacts-${{ github.run_id }}
          path: |
            ${{ env.REPORT_FILE }}
            ${{ env.URL_LIST_FILE }}
            wallpapers.log
          retention-days: 7
          if-no-files-found: warn
          
      # æ­¥éª¤11: æœ€ç»ˆçŠ¶æ€
      - name: Final Status
        run: |
          echo "======= WALLPAPER SYNC COMPLETE ======="
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Workflow: $GITHUB_WORKFLOW"
          echo "Run ID: $GITHUB_RUN_ID"
          echo "Repository: $GITHUB_REPOSITORY"
          if [ -f "${{ env.REPORT_FILE }}" ]; then
            echo "Report: ${{ env.REPORT_FILE }}"
            cat "${{ env.REPORT_FILE }}"
          fi
          echo "âœ… Wallpaper sync completed successfully"
          echo "======================================"
