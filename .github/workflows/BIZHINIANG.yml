name: Bilibili Wallpaper Girl Sync

on:
  workflow_dispatch:
  schedule:
    - cron: '10 1 * * *'  # UTCæ—¶é—´01:10 (åŒ—äº¬æ—¶é—´09:10)

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync-wallpapers:
    name: Sync Bilibili Wallpapers
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      OUTPUT_DIR: bizhiniang
      REPORT_FILE: wallpaper_report.md
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            getwallpaper.py
            requirements.txt
            ${{ env.OUTPUT_DIR }}/
          sparse-checkout-cone-mode: false

      - name: Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Wallpaper Downloader
        env:
          SESSDATA: ${{ secrets.SESSDATA }}
        run: |
          set -euo pipefail
          
          # Validate environment variables
          if [ -z "${SESSDATA}" ]; then
            echo "::error::Missing required SESSDATA environment variable"
            exit 1
          fi
          
          echo "Starting wallpaper download process..."
          python getwallpaper.py --sessdata "${SESSDATA}" --output "${{ env.OUTPUT_DIR }}" || {
            echo "::warning::Wallpaper download encountered errors, but workflow will continue"
          }

      - name: Configure Git
        run: |
          git config --global user.email "non-reply@github.com"
          git config --global user.name "GitHub Actions"

      - name: Commit Changes
        run: |
          set -euo pipefail
          
          # Check if any files have been modified/added
          if [ -n "$(git status --porcelain)" ]; then
            echo "Detected changes, committing..."
            git add "${{ env.OUTPUT_DIR }}/" urls.txt
            git commit -m "ðŸ–¼ï¸ Automated wallpaper update [skip ci]"
          else
            echo "No changes to commit"
          fi

      - name: Push Changes
        run: |
          set -euo pipefail
          
          # Configure remote URL with token
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/$GITHUB_REPOSITORY"
          
          # Push changes
          if git push origin "HEAD:$GITHUB_REF_NAME"; then
            echo "Push completed successfully"
          else
            echo "::error::Failed to push changes"
            exit 1
          fi

      - name: Generate Sync Report
        run: |
          set -euo pipefail
          
          {
            echo "# Wallpaper Sync Report"
            echo ""
            echo "## Execution Details"
            echo "- **Sync Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "- **Workflow Run**: [$GITHUB_RUN_ID](https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)"
            echo ""
            
            # Calculate directory sizes and counts
            if [ -d "${{ env.OUTPUT_DIR }}" ]; then
              album_count=$(find "${{ env.OUTPUT_DIR }}" -mindepth 1 -maxdepth 1 -type d | wc -l)
              image_count=$(find "${{ env.OUTPUT_DIR }}" -type f | wc -l)
              
              echo "## Storage Summary"
              echo "- **Album Directories**: $album_count"
              echo "- **Image Files**: $image_count"
              echo "- **Latest Album**: $(ls -t "${{ env.OUTPUT_DIR }}" | head -n 1)"
            else
              echo "## âš ï¸ Warning"
              echo "Output directory not found!"
            fi
            
            echo ""
            echo "## Repository Status"
            echo "```"
            git status --short
            echo "```"
          } > "${{ env.REPORT_FILE }}"

      - name: Upload Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wallpaper-report
          path: |
            ${{ env.REPORT_FILE }}
            urls.txt
          retention-days: 7
          
      - name: Final Status
        run: |
          if [ -f "${{ env.REPORT_FILE }}" ]; then
            cat "${{ env.REPORT_FILE }}"
          fi
          echo "ðŸš€ Wallpaper sync completed successfully"
