name: KAIPINGTU

on:
  workflow_dispatch:
  schedule:
    - cron: '1 20 * * *'

jobs:
  start:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0  # 获取完整历史记录

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install requests  # 确保安装requests库

      - name: 下载开屏图
        run: |
          python get_app_splash.py || echo "开屏图下载失败"

      - name: commit
        run: |
          git config --global user.email "non-reply@github.com"
          git config --global user.name "GitHub Action"
          git add .
          # 避免没有变化时失败
          git diff --quiet && git diff --staged --quiet || git commit -m "B站开屏图更新"
          echo "提交状态: $?"

      # 使用原生Git替代ad-m/github-push-action
      - name: Push changes
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          git push origin HEAD:$GITHUB_REF_NAME
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}

      - name: Make preview file
        run: |
          {
            echo "bilibili开屏图下载报告"
            echo "========================"
            echo "完成时间: $(date)"
            echo "下载图片数: $(find app_splash -type f -name '*.jpg' -or -name '*.png' -or -name '*.webp' | wc -l)"
            echo "文件列表:"
            ls -lh app_splash
          } > report.txt
