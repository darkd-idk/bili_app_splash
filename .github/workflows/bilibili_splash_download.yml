name: Bilibili Splash Download

on:
  workflow_dispatch:
    inputs:
      use_proxy:
        description: 'Use proxy for Bilibili API'
        required: false
        type: boolean
        default: false
      enable_debug:
        description: 'Enable debug logging'
        required: false
        type: boolean
        default: false
  schedule:
    - cron: '0 * * * *'  # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡
  
  push:
    paths-ignore:
      - 'splash/**'

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  download-splash:
    name: "Download Bilibili Splash Images"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    env:
      SPLASH_DIR: 'splash'
      SCRIPT_FILE: 'splash_downloader.py'
      REPORT_FILE: 'splash_report.md'
      REPORT_DIR: '.reports'
      URL_LIST_FILE: 'splash_urls.txt'
      LOG_FILE: 'splash.log'
      PYTHON_VERSION: '3.11'

    steps:
      # æ­¥éª¤1: å‡†å¤‡ç¯å¢ƒ
      - name: "Setup Environment"
        run: |
          echo "ğŸ› ï¸ WORKFLOW STARTED AT: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Runner OS: $(uname -a)"
          echo "Current directory: $(pwd)"
          echo "Use Proxy: ${{ inputs.use_proxy }}"
          echo "Enable Debug: ${{ inputs.enable_debug }}"
          echo "Existing splash directory:"
          ls -la splash/ || true
          echo "Python version: $(python --version)"

      # æ­¥éª¤2: æ£€å‡ºä»“åº“
      - name: "Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å®Œæ•´æ£€å‡ºå†å²è®°å½•

      # æ­¥éª¤3: è®¾ç½®Pythonç¯å¢ƒ
      - name: "Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      # æ­¥éª¤4: å®‰è£…ä¾èµ–
      - name: "Install Dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install requests tzlocal user-agent
          echo "âœ”ï¸ Python dependencies installed"

      # æ­¥éª¤5: å‡†å¤‡è¾“å‡ºç›®å½•å’Œæ–‡ä»¶
      - name: "Prepare Workspace"
        run: |
          mkdir -p "$SPLASH_DIR"
          touch "$URL_LIST_FILE"
          touch "$LOG_FILE"
          echo "ğŸ“ Workspace prepared"
          echo "Output dir: $SPLASH_DIR"
          echo "URL list: $URL_LIST_FILE"
          echo "Log file: $LOG_FILE"

      # æ­¥éª¤6: æ‰§è¡Œå¼€å±å›¾ä¸‹è½½ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
      - name: "Download Splash Images"
        run: |
          set -euo pipefail
          
          # é‡ç½®æ—¥å¿—æ–‡ä»¶
          echo "[$(date -u '+%Y-%m-%d %H:%M:%S')] ğŸš€ Start splash download" > "$LOG_FILE"
          
          echo "ğŸ”½ Starting splash image download..."
          
          # æ„å»ºå‘½ä»¤è¡Œå‚æ•°
          cmd_args=()
          cmd_args+=("--output" "$SPLASH_DIR")
          cmd_args+=("--url-file" "$URL_LIST_FILE")
          cmd_args+=("--log-file" "$LOG_FILE")
          
          if [ "${{ inputs.use_proxy }}" = "true" ]; then
            cmd_args+=("--proxy")
            echo "ğŸ”Œ Using proxy connection"
          fi
          
          if [ "${{ inputs.enable_debug }}" = "true" ]; then
            cmd_args+=("--debug")
            echo "ğŸ› Debug mode enabled"
          fi
          
          # æœ€å¤§é‡è¯•æ¬¡æ•°
          max_retries=3
          exit_status=1
          
          for ((attempt=1; attempt<=max_retries; attempt++)); do
            echo "ğŸ’« Attempt #$attempt to download splash images"
            
            # æ‰§è¡Œä¸‹è½½å‘½ä»¤
            if python "$SCRIPT_FILE" "${cmd_args[@]}"; then
              echo "DOWNLOAD_STATUS=Success" >> $GITHUB_ENV
              echo "âœ… Download completed successfully"
              exit_status=0
              break
            else
              echo "âŒ Download attempt $attempt failed"
              
              # å¦‚æœä¸æ˜¯æœ€åä¸€æ¬¡å°è¯•ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
              if [ $attempt -lt $max_retries ]; then
                wait_time=$((attempt * 10))
                echo "â³ Retrying in $wait_time seconds..."
                sleep $wait_time
              else
                echo "DOWNLOAD_STATUS=Failed" >> $GITHUB_ENV
                echo "âŒ All download attempts failed"
              fi
            fi
          done
          
          # è®¡ç®—æ–°æ–‡ä»¶æ•°
          NEW_FILES_COUNT=$(find "$SPLASH_DIR" -type f -mmin -5 | wc -l) || 0
          echo "NEW_FILES_COUNT=$NEW_FILES_COUNT" >> $GITHUB_ENV
          echo "ğŸ“¥ Downloaded $NEW_FILES_COUNT new files"
          
          # ä¿å­˜é€€å‡ºçŠ¶æ€
          echo "SCRIPT_EXIT_STATUS=$exit_status" >> $GITHUB_ENV
          echo "EXIT_STATUS=$exit_status" >> $GITHUB_OUTPUT
          exit $exit_status

      # æ­¥éª¤7: APIå“åº”åˆ†æ
      - name: "Analyze API Response"
        if: ${{ env.DOWNLOAD_STATUS != 'Success' || env.NEW_FILES_COUNT == 0 }}
        run: |
          set -euo pipefail
          
          echo "ğŸ” Analyzing API response..."
          
          # åˆ—å‡ºæ‰€æœ‰APIå“åº”æ–‡ä»¶
          echo "=== API Response Files ==="
          find . -name "api_response_*.txt" | while read file; do
            echo "ğŸ“„ $file"
            echo "Size: $(stat -c%s "$file") bytes"
            head -c 200 "$file"
            echo ""
          done
          
          # æ£€æŸ¥Cloudflare
          if grep -q "Cloudflare" $(find . -name "api_response_*.txt" -print -quit); then
            echo "::error::Cloudflare challenge detected"
          fi
          
          # æ£€æŸ¥å†…å®¹ç±»å‹
          content_type=$(find . -name "api_response_*.txt" -print0 | xargs -0 head -n 1 | grep -i "content-type" || true)
          if [[ -n "$content_type" ]]; then
            echo "Content-Type: $content_type"
          else
            echo "::warning::No Content-Type header found"
          fi
          
          # å°è¯•æ‰‹åŠ¨è§£æJSON
          if command -v jq &> /dev/null; then
            echo "=== JSON Validation ==="
            find . -name "api_response_*.txt" | while read file; do
              if head -1 "$file" | grep -q "{"; then
                jq . "$file" > /dev/null && echo "âœ… Valid JSON: $file" || echo "âŒ Invalid JSON: $file"
              fi
            done
          else
            echo "âš ï¸ jq not installed, skipping JSON validation"
          fi
          
          # ç½‘ç»œè¿é€šæ€§æµ‹è¯•
          echo "=== Network Test ==="
          curl -I "https://app.bilibili.com" -v || true
          curl -I "https://api.bilibili.com" -v || true
          curl "https://ipinfo.io" -m 5 || true

      # æ­¥éª¤8: å‡†å¤‡Gité…ç½®
      - name: "Setup Git Identity"
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions@users.noreply.github.com"
          echo "ğŸ‘¤ Git user configured"

      # æ­¥éª¤9: æ£€æŸ¥å˜æ›´çŠ¶æ€
      - name: "Check Changes"
        run: |
          set -euo pipefail
          
          # åˆå§‹åŒ–å˜æ›´æ ‡å¿—
          HAS_CHANGES="false"
          
          # æ˜¾ç¤ºGitçŠ¶æ€
          echo "ğŸ“‹ Current workspace status:"
          git status --short
          
          # æ£€æŸ¥SPLASH_DIRæ˜¯å¦å­˜åœ¨
          if [ ! -d "$SPLASH_DIR" ]; then
            echo "âŒ Splash directory '$SPLASH_DIR' does not exist!"
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
            exit 0
          fi
          
          # æ£€æŸ¥ç›®å½•å†…å®¹
          echo "ğŸ“‚ Contents of $SPLASH_DIR:"
          ls -la "$SPLASH_DIR" || true
          
          # æ–¹æ³•1: æ£€æŸ¥æœªè·Ÿè¸ªæ–‡ä»¶
          if [ -n "$(git ls-files --others --exclude-standard)" ]; then
            echo "ğŸ”„ Changes detected: untracked files"
            HAS_CHANGES="true"
          fi
          
          # æ–¹æ³•2: æ£€æŸ¥å·²ä¿®æ”¹æ–‡ä»¶
          if ! git diff --quiet; then
            echo "ğŸ”„ Changes detected: modified files"
            HAS_CHANGES="true"
          fi
          
          # æ–¹æ³•3: å¦‚æœæœ‰æ–°æ–‡ä»¶ä½†Gitæ²¡æ£€æµ‹åˆ°
          if [ "$NEW_FILES_COUNT" -gt 0 ] && [ "$HAS_CHANGES" = "false" ]; then
            echo "âš ï¸ $NEW_FILES_COUNT new files but Git not detecting changes"
            echo "ğŸ”„ Forcing detection of new files"
            git add "$SPLASH_DIR" || true
            HAS_CHANGES="true"
          fi
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          echo "HAS_CHANGES=$HAS_CHANGES" >> $GITHUB_ENV
          echo "ğŸ”„ Changes detected: $HAS_CHANGES"

      # æ­¥éª¤10: æäº¤å˜æ›´ï¼ˆå¦‚æœä¸‹è½½æˆåŠŸä¸”æœ‰å˜æ›´ï¼‰
      - name: "Commit Changes"
        if: ${{ env.DOWNLOAD_STATUS == 'Success' && env.HAS_CHANGES == 'true' }}
        run: |
          set -euo pipefail
          
          # æ·»åŠ æ‰€æœ‰å·²æ›´æ”¹çš„æ–‡ä»¶
          echo "â• Adding changed files..."
          git add "$SPLASH_DIR" || true
          git add "$URL_LIST_FILE" || true
          
          # æ˜¾ç¤ºæ·»åŠ åçš„çŠ¶æ€
          echo "ğŸ“‹ Staged changes:"
          git diff --cached --name-only
          
          # è®¡ç®—å®é™…å˜æ›´å¤šå°‘æ–‡ä»¶
          change_count=$(git diff --cached --name-only | wc -l) || 0
          echo "ğŸ“ˆ Detected $change_count file changes"
          
          # æäº¤å˜æ›´
          if [ "$change_count" -gt 0 ]; then
            echo "ğŸ’¾ Committing changes..."
            git commit -m "ğŸŒ… Automated splash image update [skip ci]"
            echo "âœ… Changes committed"
          else
            echo "ğŸŸ¢ No files to commit after staging"
          fi

      # æ­¥éª¤11: æ¨é€å˜æ›´
      - name: "Push Changes"
        if: ${{ env.DOWNLOAD_STATUS == 'Success' && env.HAS_CHANGES == 'true' }}
        run: |
          set -euo pipefail
          
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/$GITHUB_REPOSITORY"
          
          max_retries=3
          
          echo "ğŸšš Attempting to push changes..."
          for i in $(seq 1 $max_retries); do
            # è·å–è¿œç¨‹æœ€æ–°æ›´æ”¹
            git fetch origin
            
            # å˜åŸºåˆ°è¿œç¨‹æœ€æ–°çŠ¶æ€
            echo "ğŸ” Rebasing onto remote branch..."
            if git rebase origin/$GITHUB_REF_NAME; then
              # å°è¯•æ¨é€
              if git push origin HEAD:$GITHUB_REF_NAME; then
                echo "ğŸš€ Push successful"
                exit 0
              else
                echo "âš ï¸ Push failed, retry $i/$max_retries in 10s"
                sleep 10
              fi
            else
              echo "âŒ Rebase conflict! Showing git status:"
              git status
              exit 1
            end
          done
          
          echo "::error::Push failed after $max_retries attempts"
          exit 1

      # æ­¥éª¤12: ç”ŸæˆæŠ¥å‘Š
      - name: "Generate Report"
        run: |
          set -euo pipefail
          
          # ç¡®ä¿æŠ¥å‘Šç›®å½•å­˜åœ¨
          mkdir -p "$REPORT_DIR"
          
          # åˆ›å»ºæŠ¥å‘Šæ–‡ä»¶è·¯å¾„
          report_path="$REPORT_DIR/$REPORT_FILE"
          
          # è·å–æ—¥å¿—å†…å®¹
          if [ -f "$LOG_FILE" ] && [ -s "$LOG_FILE" ]; then
            log_content=$(cat "$LOG_FILE")
          else
            log_content="No log content available"
          fi
          
          # è®¡ç®—å›¾ç‰‡æ•°é‡
          image_count=$(find "$SPLASH_DIR" -type f | wc -l) || 0
          
          # ç”ŸæˆæŠ¥å‘Šå†…å®¹
          echo "# Bilibili Splash Image Download Report" > "$report_path"
          echo "- **Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> "$report_path"
          echo "- **Workflow**: $GITHUB_WORKFLOW" >> "$report_path"
          echo "- **Run ID**: [$GITHUB_RUN_ID](https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)" >> "$report_path"
          echo "- **Download Status**: $DOWNLOAD_STATUS" >> "$report_path"
          echo "- **Exit Status**: $SCRIPT_EXIT_STATUS" >> "$report_path"
          echo "- **Proxy Used**: ${{ inputs.use_proxy }}" >> "$report_path"
          echo "- **Debug Enabled**: ${{ inputs.enable_debug }}" >> "$report_path"
          echo "- **Splash Directory**: $SPLASH_DIR" >> "$report_path"
          echo "- **Image Count**: $image_count" >> "$report_path"
          echo "- **New Files Downloaded**: $NEW_FILES_COUNT" >> "$report_path"
          echo "- **Changes Committed**: $HAS_CHANGES" >> "$report_path"
          echo "- **Raw API Responses**: $(find . -name "api_response_*.txt" | wc -l) files" >> "$report_path"
          echo "" >> "$report_path"
          echo "## Download Log" >> "$report_path"
          echo "\`\`\`" >> "$report_path"
          echo "$log_content" >> "$report_path"
          echo "\`\`\`" >> "$report_path"
          
          echo "ğŸ“Š Report generated at $report_path"

      # æ­¥éª¤13: ä¸Šä¼ åˆ¶å“
      - name: "Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: "splash-artifacts-${{ github.run_id }}"
          path: |
            ${{ env.REPORT_DIR }}/
            ${{ env.LOG_FILE }}
            ${{ env.URL_LIST_FILE }}
            $(find . -name "api_response_*.txt")
          if-no-files-found: warn
          retention-days: 7

      # æ­¥éª¤14: æœ€ç»ˆçŠ¶æ€
      - name: "Final Status"
        run: |
          echo "ğŸ WORKFLOW COMPLETED: $DOWNLOAD_STATUS"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Run ID: $GITHUB_RUN_ID"
          echo "Repository: $GITHUB_REPOSITORY"
          echo "New files downloaded: $NEW_FILES_COUNT"
          echo "Changes committed: $HAS_CHANGES"
          echo "Exit Status: $SCRIPT_EXIT_STATUS"
          
          # å¦‚æœå¤±è´¥ï¼Œä½¿ä»»åŠ¡æ ‡è®°ä¸ºå¤±è´¥
          if [ "$SCRIPT_EXIT_STATUS" != "0" ]; then
            echo "::error::Splash image download failed with exit code $SCRIPT_EXIT_STATUS"
            exit 1
          fi
