name: Bilibili Splash Download

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'  # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡
  
  push:
    paths-ignore:
      - 'splash/**'

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  download-splash:
    name: "Download Bilibili Splash Images"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    env:
      SPLASH_DIR: 'splash'
      SCRIPT_FILE: 'splash_downloader.py'
      REPORT_FILE: 'splash_report.md'
      REPORT_DIR: '.reports'
      URL_LIST_FILE: 'splash_urls.txt'

    steps:
      # æ­¥éª¤1: å‡†å¤‡ç¯å¢ƒ
      - name: "Setup Environment"
        run: |
          echo "ğŸ› ï¸ WORKFLOW STARTED AT: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Runner OS: $(uname -a)"
          echo "Current directory: $(pwd)"
          echo "Git status:"
          git status --short || true

      # æ­¥éª¤2: æ£€å‡ºä»“åº“ï¼ˆå®Œæ•´æ£€å‡ºï¼‰
      - name: "Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å®Œæ•´æ£€å‡ºå†å²è®°å½•
          # é¿å…ç¨€ç–æ£€å‡ºé—®é¢˜
          sparse-checkout: "" 

      # æ­¥éª¤3: è®¾ç½®Pythonç¯å¢ƒ
      - name: "Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # æ­¥éª¤4: å®‰è£…ä¾èµ–
      - name: "Install Dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # æ­¥éª¤5: æ‰§è¡Œå¼€å±å›¾ä¸‹è½½
      - name: "Download Splash Images"
        run: |
          set -euo pipefail
          
          # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
          mkdir -p "$SPLASH_DIR"
          
          # æ‰§è¡Œä¸‹è½½è„šæœ¬
          echo "ğŸ”½ Starting splash image download..."
          python "$SCRIPT_FILE" \
            --output "$SPLASH_DIR" \
            --log-file splash.log \
            --debug
          
          echo "âœ… Download completed"
        
      # æ­¥éª¤6: å‡†å¤‡Gité…ç½®
      - name: "Setup Git Identity"
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions@users.noreply.github.com"
          echo "ğŸ‘¤ Git user configured"

      # æ­¥éª¤7: æ£€æŸ¥å˜æ›´çŠ¶æ€
      - name: "Check Changes"
        id: check-changes
        run: |
          set -euo pipefail
          
          # æ˜¾ç¤ºæ‰€æœ‰å˜æ›´
          echo "ğŸ“‹ Current workspace status:"
          git status --short
          
          # æ£€æŸ¥splashç›®å½•æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet "$SPLASH_DIR"; then
            echo "ğŸŸ¢ No changes in splash directory"
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          else
            echo "ğŸ”„ Changes detected in splash directory"
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
          fi
          
          # æ£€æŸ¥URLæ–‡ä»¶
          if git diff --quiet "$URL_LIST_FILE"; then
            echo "ğŸŸ¢ No changes in URL file"
            echo "URL_CHANGES=false" >> $GITHUB_ENV
          else
            echo "ğŸ”„ Changes detected in URL file"
            echo "URL_CHANGES=true" >> $GITHUB_ENV
          fi

      # æ­¥éª¤8: æäº¤å˜æ›´
      - name: "Commit Changes"
        if: ${{ env.HAS_CHANGES == 'true' || env.URL_CHANGES == 'true' }}
        run: |
          set -euo pipefail
          
          # æ·»åŠ æ‰€æœ‰å·²æ›´æ”¹çš„æ–‡ä»¶
          echo "â• Adding changed files..."
          git add "$SPLASH_DIR" || true
          git add "$URL_LIST_FILE" || true
          
          # æ˜¾ç¤ºæ·»åŠ åçš„çŠ¶æ€
          echo "ğŸ“‹ Staged changes:"
          git diff --cached --name-only
          
          # è®¡ç®—å®é™…å˜æ›´å¤šå°‘æ–‡ä»¶
          change_count=$(git diff --cached --name-only | wc -l)
          echo "ğŸ“ˆ Detected $change_count file changes"
          
          # æäº¤å˜æ›´
          if [ "$change_count" -gt 0 ]; then
            echo "ğŸ’¾ Committing changes..."
            git commit -m "ğŸŒ… Automated splash image update [skip ci]"
            echo "âœ… Changes committed"
          else
            echo "ğŸŸ¢ No files to commit after staging"
          fi

      # æ­¥éª¤9: æ¨é€å˜æ›´
      - name: "Push Changes"
        if: ${{ env.HAS_CHANGES == 'true' || env.URL_CHANGES == 'true' }}
        run: |
          set -euo pipefail
          
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/$GITHUB_REPOSITORY"
          
          max_retries=3
          
          for i in $(seq 1 $max_retries); do
            # è·å–è¿œç¨‹æœ€æ–°æ›´æ”¹
            git fetch origin
            
            # å˜åŸºåˆ°è¿œç¨‹æœ€æ–°çŠ¶æ€
            if git rebase origin/$GITHUB_REF_NAME; then
              # å°è¯•æ¨é€
              if git push origin HEAD:$GITHUB_REF_NAME; then
                echo "ğŸš€ Push successful"
                exit 0
              fi
            else
              echo "âŒ Rebase conflict! Showing git status:"
              git status
              exit 1
            fi
            
            echo "âš ï¸ Push failed, retry $i/$max_retries in 5s"
            sleep 5
          done
          
          echo "::error::Push failed after $max_retries attempts"
          exit 1

      # æ­¥éª¤10: ç”ŸæˆæŠ¥å‘Š
      - name: "Generate Report"
        run: |
          set -euo pipefail
          
          mkdir -p "$REPORT_DIR"
          
          log_content=""
          if [ -f splash.log ]; then
            log_content=$(tail -n 30 splash.log)
          else
            log_content="No log file found"
          fi
          
          image_count=0
          if [ -d "$SPLASH_DIR" ]; then
            image_count=$(find "$SPLASH_DIR" -type f | wc -l)
          fi
          
          report_file="$REPORT_DIR/$REPORT_FILE"
          
          echo "# Splash Image Download Report" > $report_file
          echo "- **Date**: $(date -u)" >> $report_file
          echo "- **Workflow**: $GITHUB_WORKFLOW" >> $report_file
          echo "- **Run ID**: [$GITHUB_RUN_ID](https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)" >> $report_file
          echo "- **Image Count**: $image_count" >> $report_file
          echo "- **Changes Detected**: ${HAS_CHANGES:-false}" >> $report_file
          echo "" >> $report_file
          echo "## Log Summary" >> $report_file
          echo "\`\`\`" >> $report_file
          echo "$log_content" >> $report_file
          echo "\`\`\`" >> $report_file
          
          echo "ğŸ“Š Report generated at $report_file"

      # æ­¥éª¤11: ä¸Šä¼ åˆ¶å“
      - name: "Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: "splash-artifacts-${{ github.run_id }}"
          path: |
            $REPORT_DIR/
            splash.log
            $URL_LIST_FILE
          retention-days: 7
