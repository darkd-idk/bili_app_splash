name: Bilibili Splash Download

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'  # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡
  
  push:
    paths-ignore:
      - 'splash/**'

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  download-splash:
    name: "Download Bilibili Splash Images"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    env:
      SPLASH_DIR: 'splash'
      SCRIPT_FILE: 'splash_downloader.py'
      REPORT_FILE: 'splash_report.md'
      REPORT_DIR: '.reports'
      URL_LIST_FILE: 'splash_urls.txt'
      LOG_FILE: 'splash.log'  # æ–°å¢æ˜ç¡®çš„æ—¥å¿—æ–‡ä»¶å˜é‡

    steps:
      # ...å‰é¢çš„æ­¥éª¤ä¿æŒä¸å˜...
      
      # æ­¥éª¤10: ç”ŸæˆæŠ¥å‘Š
      - name: "Generate Report"
        run: |
          set -euo pipefail
          
          # ç¡®ä¿æŠ¥å‘Šç›®å½•å­˜åœ¨
          mkdir -p "$REPORT_DIR"
          
          # åˆ›å»ºæŠ¥å‘Šæ–‡ä»¶
          report_path="$REPORT_DIR/$REPORT_FILE"
          
          # ç¡®ä¿æ—¥å¿—æ–‡ä»¶å­˜åœ¨ï¼ˆå³ä½¿ä¸ºç©ºï¼‰
          if [ ! -f "$LOG_FILE" ]; then
            touch "$LOG_FILE"
            echo "No log content available" > "$LOG_FILE"
          fi
          
          # ç¡®ä¿URLåˆ—è¡¨æ–‡ä»¶å­˜åœ¨
          if [ ! -f "$URL_LIST_FILE" ]; then
            touch "$URL_LIST_FILE"
          fi
          
          # è·å–æ—¥å¿—å†…å®¹
          log_content=$(cat "$LOG_FILE")
          
          # ç”ŸæˆæŠ¥å‘Šå†…å®¹
          echo "# Splash Image Download Report" > "$report_path"
          echo "- **Date**: $(date -u)" >> "$report_path"
          echo "- **Workflow**: $GITHUB_WORKFLOW" >> "$report_path"
          echo "- **Run ID**: [$GITHUB_RUN_ID](https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)" >> "$report_path"
          echo "- **Download Status**: ${DOWNLOAD_STATUS:-Unknown}" >> "$report_path"
          echo "" >> "$report_path"
          echo "## Download Log" >> "$report_path"
          echo "\`\`\`" >> "$report_path"
          echo "$log_content" >> "$report_path"
          echo "\`\`\`" >> "$report_path"
          
          echo "ğŸ“Š Report generated at $report_path"

      # æ­¥éª¤11: ä¸Šä¼ åˆ¶å“ï¼ˆä¿®å¤ç‰ˆï¼‰
      - name: "Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: "splash-artifacts-${{ github.run_id }}"
          path: |
            ${{ env.REPORT_DIR }}/${{ env.REPORT_FILE }}
            ${{ env.LOG_FILE }}
            ${{ env.URL_LIST_FILE }}
          if-no-files-found: error # å¦‚æœæ‰¾ä¸åˆ°æ–‡ä»¶ï¼ŒæŠ¥å‘Šé”™è¯¯ä½†ç»§ç»­å·¥ä½œæµ
          retention-days: 7
