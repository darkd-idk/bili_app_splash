name: Bilibili Splash Sync

on:
  workflow_dispatch:
  schedule:
    - cron: '1 20 * * *'  # UTC时间20:01（北京时间次日04:01）
  push:
    branches:
      - main
    paths-ignore:
      - 'app_splash/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync-splash-images:
    name: 同步B站开屏图
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: 检出代码库
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            get_app_splash.py
            requirements.txt
            .github/
            app_splash/
          sparse-checkout-cone-mode: false
          lfs: false

      - name: 设置Python环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: 下载开屏图
        run: python get_app_splash.py || echo "下载过程中出现错误"

      - name: 配置Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'non-reply@github.com'

      - name: 提交变更
        run: |
          # 检查是否有变更需要提交
          if ! git diff --quiet || ! git diff --staged --quiet; then
            git add .
            git commit -m "自动更新开屏图 - $(date +'%Y-%m-%d %H:%M')"
          else
            echo "没有需要提交的变更"
          fi

      - name: 推送到仓库
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          
          # 尝试推送，最多重试3次
          for i in {1..3}; do
            git push origin HEAD:$GITHUB_REF_NAME && break
            echo "推送失败，10秒后重试 ($i/3)..."
            sleep 10
          done
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}

      - name: 生成Markdown报告
        run: |
          # 安全的图片计数
          if [ -d app_splash ]; then
            image_count=$(find app_splash -maxdepth 1 -type f $ -name "*.jpg" -o -name "*.png" -o -name "*.webp" $ 2>/dev/null | wc -l)
          else
            image_count=0
          fi
          
          # 获取最新5个文件（避免管道错误）
          if [ -d app_splash ] && [ "$(ls -A app_splash 2>/dev/null)" ]; then
            latest_files=$(ls -t app_splash 2>/dev/null | head -n 5 | awk '{print "- " $0}')
          else
            latest_files="- 没有找到文件"
          fi
          
          # 生成报告文件
          echo "# B站开屏图同步报告" > report.md
          echo "" >> report.md
          echo "**同步时间**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> report.md
          echo "**图片总数**: $image_count" >> report.md
          echo "" >> report.md
          echo "## 最新5个文件" >> report.md
          echo "$latest_files" >> report.md
          echo "" >> report.md
          echo "## 状态" >> report.md
          echo "✅ 所有文件已成功同步" >> report.md

      - name: 上传报告制品
        uses: actions/upload-artifact@v4
        with:
          name: splash-report
          path: |
            report.md
            app_splash/download_report.json
          retention-days: 7
