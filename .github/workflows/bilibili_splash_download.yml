name: Bilibili Splash Download

on:
  workflow_dispatch:
    inputs:
      use_proxy:
        description: 'Use proxy for Bilibili API'
        required: false
        type: boolean
        default: false
      enable_debug:
        description: 'Enable debug logging'
        required: false
        type: boolean
        default: false
  schedule:
    - cron: '0 * * * *'  # 每小时运行一次
  
  push:
    paths-ignore:
      - 'splash/**'

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  download-splash:
    name: "Download Bilibili Splash Images"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    env:
      SPLASH_DIR: 'splash'
      SCRIPT_FILE: 'splash_downloader.py'
      REPORT_FILE: 'splash_report.md'
      REPORT_DIR: '.reports'
      URL_LIST_FILE: 'splash_urls.txt'
      LOG_FILE: 'splash.log'
      PYTHON_VERSION: '3.11'

    steps:
      # 步骤1: 准备环境
      - name: "Setup Environment"
        run: |
          echo "🛠️ WORKFLOW STARTED AT: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Runner OS: $(uname -a)"
          echo "Current directory: $(pwd)"
          echo "Use Proxy: ${{ inputs.use_proxy }}"
          echo "Enable Debug: ${{ inputs.enable_debug }}"
          echo "Existing splash directory:"
          ls -la splash/ || true

      # 步骤2: 检出仓库
      - name: "Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 完整检出历史记录

      # 步骤3: 设置Python环境
      - name: "Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      # 步骤4: 安装依赖
      - name: "Install Dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "✔️ Python dependencies installed"

      # 步骤5: 准备输出目录
      - name: "Ensure Output Directory"
        run: |
          mkdir -p "$SPLASH_DIR"
          touch "$URL_LIST_FILE"
          touch "$LOG_FILE"
          echo "📂 Output directory: $SPLASH_DIR"
          echo "🔤 URL list file: $URL_LIST_FILE"
          echo "📝 Log file: $LOG_FILE"

      # 步骤6: 执行开屏图下载
      - name: "Download Splash Images"
        run: |
          set -euo pipefail
          
          # 重置日志文件
          echo "[$(date -u '+%Y-%m-%d %H:%M:%S')] 🚀 Start splash download" > "$LOG_FILE"
          
          echo "🔽 Starting splash image download..."
          
          # 构建命令行参数
          cmd_args=(
            "--output" "$SPLASH_DIR"
            "--url-file" "$URL_LIST_FILE"
            "--log-file" "$LOG_FILE"
          )
          
          if [ "${{ inputs.use_proxy }}" = "true" ]; then
            cmd_args+=("--proxy")
            echo "🔌 Using proxy connection"
          fi
          
          if [ "${{ inputs.enable_debug }}" = "true" ]; then
            cmd_args+=("--debug")
            echo "🐛 Debug mode enabled"
          fi
          
          # 执行下载命令
          if python "$SCRIPT_FILE" "${cmd_args[@]}"; then
            echo "DOWNLOAD_STATUS=Success" >> $GITHUB_ENV
            echo "✅ Download completed successfully"
          else
            echo "DOWNLOAD_STATUS=Failed" >> $GITHUB_ENV
            echo "❌ Download encountered errors"
          fi
          
          # 计算新文件数
          NEW_FILES_COUNT=$(find "$SPLASH_DIR" -type f -mmin -5 | wc -l) || 0
          echo "NEW_FILES_COUNT=$NEW_FILES_COUNT" >> $GITHUB_ENV
          echo "📥 Downloaded $NEW_FILES_COUNT new files"

      # 步骤7: 调试API响应（失败时）
      - name: "Debug API Response"
        if: ${{ env.DOWNLOAD_STATUS != 'Success' || env.NEW_FILES_COUNT == 0 }}
        run: |
          set -euo pipefail
          
          echo "🔍 Debugging API response..."
          
          # 显示API日志
          echo "=== Splash Download Log ==="
          cat "$LOG_FILE" || true
          
          # 如果有API响应文件，显示它
          if [ -f "api_response.json" ]; then
            echo "=== API Response ==="
            cat "api_response.json" || true
          else
            echo "No API response file found"
          fi
          
          # 网络连通性测试
          echo "=== Network Test ==="
          curl -I "https://app.bilibili.com" -v || true
          curl -I "https://api.bilibili.com" -v || true
          curl "https://ipinfo.io" || true

      # 步骤8: 准备Git配置
      - name: "Setup Git Identity"
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions@users.noreply.github.com"
          echo "👤 Git user configured"

      # 步骤9: 检查变更状态
      - name: "Check Changes"
        run: |
          set -euo pipefail
          
          # 初始化变更标志
          HAS_CHANGES="false"
          
          # 显示Git状态
          echo "📋 Current workspace status:"
          git status --short
          
          # 检查目录是否存在
          if [ ! -d "$SPLASH_DIR" ]; then
            echo "❌ ERROR: Splash directory '$SPLASH_DIR' does not exist!"
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
            exit 0
          fi
          
          # 检查目录内容
          echo "📂 Contents of $SPLASH_DIR:"
          ls -la "$SPLASH_DIR" || true
          
          # 方法1: 检查未跟踪文件
          if [ -n "$(git ls-files --others --exclude-standard)" ]; then
            echo "🔄 Changes detected: untracked files"
            HAS_CHANGES="true"
          fi
          
          # 方法2: 检查已修改文件
          if ! git diff --quiet; then
            echo "🔄 Changes detected: modified files"
            HAS_CHANGES="true"
          fi
          
          # 方法3: 如果有新文件但Git没检测到
          if [ "$NEW_FILES_COUNT" -gt 0 ] && [ "$HAS_CHANGES" = "false" ]; then
            echo "⚠️ $NEW_FILES_COUNT new files but Git not detecting changes"
            echo "🔄 Forcing detection of new files"
            git add "$SPLASH_DIR" || true
            HAS_CHANGES="true"
          fi
          
          # 设置环境变量
          echo "HAS_CHANGES=$HAS_CHANGES" >> $GITHUB_ENV
          echo "🔄 Changes detected: $HAS_CHANGES"

      # 步骤10: 提交变更
      - name: "Commit Changes"
        if: ${{ env.HAS_CHANGES == 'true' }}
        run: |
          set -euo pipefail
          
          # 添加所有已更改的文件
          echo "➕ Adding changed files..."
          git add "$SPLASH_DIR" || true
          git add "$URL_LIST_FILE" || true
          
          # 显示添加后的状态
          echo "📋 Staged changes:"
          git diff --cached --name-only
          
          # 计算实际变更多少文件
          change_count=$(git diff --cached --name-only | wc -l) || 0
          echo "📈 Detected $change_count file changes"
          
          # 提交变更
          if [ "$change_count" -gt 0 ]; then
            echo "💾 Committing changes..."
            commit_message="🌅 Automated splash image update [skip ci]"
            if [ "${{ inputs.use_proxy }}" = "true" ]; then
              commit_message+=" (proxy)"
            fi
            git commit -m "$commit_message"
            echo "✅ Changes committed"
          else
            echo "🟢 No files to commit after staging"
          fi

      # 步骤11: 推送变更
      - name: "Push Changes"
        if: ${{ env.HAS_CHANGES == 'true' }}
        run: |
          set -euo pipefail
          
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/$GITHUB_REPOSITORY"
          
          max_retries=3
          
          echo "🚚 Attempting to push changes..."
          for i in $(seq 1 $max_retries); do
            # 获取远程最新更改
            git fetch origin
            
            # 变基到远程最新状态
            echo "🔁 Rebasing onto remote branch..."
            if git rebase origin/$GITHUB_REF_NAME; then
              # 尝试推送
              if git push origin HEAD:$GITHUB_REF_NAME; then
                echo "🚀 Push successful"
                exit 0
              else
                echo "⚠️ Push failed, retry $i/$max_retries in 10s"
                sleep 10
              fi
            else
              echo "❌ Rebase conflict! Showing git status:"
              git status
              exit 1
            fi
          done
          
          echo "::error::Push failed after $max_retries attempts"
          exit 1

      # 步骤12: 生成报告
      - name: "Generate Report"
        run: |
          set -euo pipefail
          
          # 确保报告目录存在
          mkdir -p "$REPORT_DIR"
          
          # 创建报告文件路径
          report_path="$REPORT_DIR/$REPORT_FILE"
          
          # 获取日志内容
          if [ -f "$LOG_FILE" ] && [ -s "$LOG_FILE" ]; then
            log_content=$(cat "$LOG_FILE")
          else
            log_content="No log content available"
          fi
          
          # 计算图片数量
          image_count=$(find "$SPLASH_DIR" -type f | wc -l) || 0
          
          # 生成报告内容
          echo "# Bilibili Splash Image Download Report" > "$report_path"
          echo "- **Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> "$report_path"
          echo "- **Workflow**: $GITHUB_WORKFLOW" >> "$report_path"
          echo "- **Run ID**: [$GITHUB_RUN_ID](https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)" >> "$report_path"
          echo "- **Download Status**: $DOWNLOAD_STATUS" >> "$report_path"
          echo "- **Proxy Used**: ${{ inputs.use_proxy }}" >> "$report_path"
          echo "- **Debug Enabled**: ${{ inputs.enable_debug }}" >> "$report_path"
          echo "- **Splash Directory**: $SPLASH_DIR" >> "$report_path"
          echo "- **Image Count**: $image_count" >> "$report_path"
          echo "- **New Files Downloaded**: $NEW_FILES_COUNT" >> "$report_path"
          echo "- **Changes Committed**: $HAS_CHANGES" >> "$report_path"
          echo "" >> "$report_path"
          echo "## Download Log" >> "$report_path"
          echo "\`\`\`" >> "$report_path"
          echo "$log_content" >> "$report_path"
          echo "\`\`\`" >> "$report_path"
          
          echo "📊 Report generated at $report_path"

      # 步骤13: 上传制品
      - name: "Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: "splash-artifacts-${{ github.run_id }}"
          path: |
            ${{ env.REPORT_DIR }}/
            ${{ env.LOG_FILE }}
            ${{ env.URL_LIST_FILE }}
            api_response.json
          if-no-files-found: warn
          retention-days: 7

      # 步骤14: 最终状态
      - name: "Final Status"
        run: |
          echo "🏁 WORKFLOW COMPLETED: $DOWNLOAD_STATUS"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Run ID: $GITHUB_RUN_ID"
          echo "Repository: $GITHUB_REPOSITORY"
          echo "New files downloaded: $NEW_FILES_COUNT"
          echo "Changes committed: $HAS_CHANGES"
          
          # 如果失败，使任务标记为失败
          if [ "$DOWNLOAD_STATUS" = "Failed" ]; then
            echo "::error::Splash image download failed"
            exit 1
          fi
